import { createManagerKey } from "@/api/helpers/kms-eth";
import { KMSClient } from "@aws-sdk/client-kms";

jest.mock("@aws-sdk/client-kms", () => ({
  KMSClient: jest.fn().mockImplementation(() => ({ send: jest.fn() })),
  CreateKeyCommand: jest.fn(),
  GetPublicKeyCommand: jest.fn(),
}));

jest.mock("@/lib/logger", () => ({ logger: { error: jest.fn() } }));

// secp256k1 generator point G in SPKI format - known test vector
const SPKI_PUBLIC_KEY = new Uint8Array([
  0x30, 0x56, 0x30, 0x10, 0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01,
  0x06, 0x05, 0x2b, 0x81, 0x04, 0x00, 0x0a, 0x03, 0x42, 0x00, 0x04, 0x79, 0xbe,
  0x66, 0x7e, 0xf9, 0xdc, 0xbb, 0xac, 0x55, 0xa0, 0x62, 0x95, 0xce, 0x87, 0x0b,
  0x07, 0x02, 0x9b, 0xfc, 0xdb, 0x2d, 0xce, 0x28, 0xd9, 0x59, 0xf2, 0x81, 0x5b,
  0x16, 0xf8, 0x17, 0x98, 0x48, 0x3a, 0xda, 0x77, 0x26, 0xa3, 0xc4, 0x65, 0x5d,
  0xa4, 0xfb, 0xfc, 0x0e, 0x11, 0x08, 0xa8, 0xfd, 0x17, 0xb4, 0x48, 0xa6, 0x85,
  0x54, 0x19, 0x9c, 0x47, 0xd0, 0x8f, 0xfb, 0x10, 0xd4, 0xb8,
]);

describe("kms-eth", () => {
  it("derives correct Ethereum address from SPKI public key", async () => {
    const client = new KMSClient({});
    (client.send as jest.Mock)
      .mockResolvedValueOnce({
        KeyMetadata: { KeyId: "key-123", CreationDate: new Date() },
      })
      .mockResolvedValueOnce({ PublicKey: SPKI_PUBLIC_KEY });

    const result = await createManagerKey(client, "rp_123");

    expect(result?.address.toLowerCase()).toBe(
      "0x7e5f4552091a69125d5dfcb7b8c2659029395bdf",
    );
  });
});
